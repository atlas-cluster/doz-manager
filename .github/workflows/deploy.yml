name: CI/CD Pipeline

on:
  push:
    branches: ['main']

env:
  REGISTRY: ghcr.io
  CONTAINER_NAME: doz-manager-app

jobs:
  test:
    name: Run Tests
    uses: ./.github/workflows/test.yml

  build:
    name: Build Image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=raw,value=${{ github.sha }}
            type=raw,value=latest

      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install & Generate Prisma
        run: |
          npm ci
          npx prisma generate

      - name: Prepare SSH (known_hosts + key)
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Generate Known_hosts dynamically for both hosts (unmasked)
          echo "Generating known_hosts..."
          JUMP_HOST="${{ secrets.JUMP_HOST }}"
          JUMP_PORT="${{ secrets.JUMP_PORT || 22 }}"
          DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
          DEPLOY_PORT="${{ secrets.DEPLOY_PORT || 22 }}"

          timeout 10 ssh-keyscan -p "$JUMP_PORT" -H "$JUMP_HOST" >> ~/.ssh/known_hosts || echo "JUMP warn: retry later"
          timeout 10 ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts || echo "DEPLOY warn: retry later"

          chmod 600 ~/.ssh/known_hosts

      - name: SSH Tunnel + Migrate
        env:
          JUMP_HOST: ${{ secrets.JUMP_HOST }}
          JUMP_USER: ${{ secrets.JUMP_USER }}
          JUMP_PORT: ${{ secrets.JUMP_PORT || 22 }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22 }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: 3306
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_ROOT_USER: ${{ secrets.DB_ROOT_USER }}
          DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=accept-new -o ConnectTimeout=10 -o ConnectionAttempts=3"

          ssh $SSH_OPTS -J "${JUMP_USER}@${JUMP_HOST}:${JUMP_PORT}" -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "echo SSH OK"

          # Start Tunnel
          echo "Tunnel -> $DB_HOST:$DB_PORT"
          ssh $SSH_OPTS -J "${JUMP_USER}@${JUMP_HOST}" \
                -p $DEPLOY_PORT -fNT -L 3306:$DB_HOST:$DB_PORT \
                $DEPLOY_USER@$DEPLOY_HOST &
          PID=$!

          sleep 5

          # Wait for Tunnel
          for i in {1..12}; do
            if timeout 1 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/3306' 2>/dev/null; then
              echo "Tunnel ready!"
              break
            fi
            echo "Waiting... $i/12"
            sleep 2
          done || { echo "Tunnel failed"; kill $PID 2>/dev/null; exit 1; }

          # Migrate
          export DB_ROOT_URL="mysql://${DB_ROOT_USER}:${DB_ROOT_PASSWORD}@127.0.0.1:3306/${DB_NAME}"
          echo "Running prisma migrate deploy..."
          npx prisma migrate deploy

          # Cleanup
          kill $PID 2>/dev/null || true
          ssh $SSH_OPTS -O exit $DEPLOY_USER@$DEPLOY_HOST 2>/dev/null || true
          echo "Cleanup done"

  deploy:
    name: Deploy Application
    needs: migrate
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (through Jump Host)
        uses: appleboy/ssh-action@v1.0.3
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ github.repository }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          IMAGE_TAG: ${{ github.sha }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: ${{ github.actor }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          proxy_host: ${{ secrets.JUMP_HOST }}
          proxy_username: ${{ secrets.JUMP_USER }}
          proxy_key: ${{ secrets.JUMP_SSH_KEY }}
          proxy_port: ${{ secrets.JUMP_PORT || 22 }}
          envs: REGISTRY,IMAGE_NAME,CONTAINER_NAME,IMAGE_TAG,DB_HOST,DB_NAME,DB_USER,DB_PASSWORD,REGISTRY_TOKEN,USERNAME
          script: |
            FULL_IMAGE_NAME=$(echo "$REGISTRY/$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
            DATABASE_URL="mysql://$DB_USER:$DB_PASSWORD@$DB_HOST:3306/$DB_NAME"

            echo "$REGISTRY_TOKEN" | docker login $REGISTRY -u $USERNAME --password-stdin
            docker pull $FULL_IMAGE_NAME:$IMAGE_TAG
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              --network host \
              -e DATABASE_URL="$DATABASE_URL" \
              -e NODE_ENV=production \
              $FULL_IMAGE_NAME:$IMAGE_TAG
            docker image prune -a -f --filter "until=24h"
