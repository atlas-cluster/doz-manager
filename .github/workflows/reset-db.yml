name: Manual DB Reset

on:
  workflow_dispatch:

jobs:
  reset:
    name: Reset Production Database
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install & Generate Prisma
        run: |
          bun install
          bunx prisma generate

      - name: Prepare SSH (known_hosts + key)
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Generate known_hosts for Jump and Deploy hosts
          JUMP_HOST="${{ secrets.JUMP_HOST }}"
          JUMP_PORT="${{ secrets.JUMP_PORT || 22 }}"
          DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
          DEPLOY_PORT="${{ secrets.DEPLOY_PORT || 22 }}"

          timeout 10 ssh-keyscan -p "$JUMP_PORT" -H "$JUMP_HOST" >> ~/.ssh/known_hosts || echo "JUMP warn: retry later"
          timeout 10 ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts || echo "DEPLOY warn: retry later"
          chmod 600 ~/.ssh/known_hosts

      - name: SSH Tunnel + Reset DB
        env:
          JUMP_HOST: ${{ secrets.JUMP_HOST }}
          JUMP_USER: ${{ secrets.JUMP_USER }}
          JUMP_PORT: ${{ secrets.JUMP_PORT || 22 }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22 }}
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=accept-new -o ConnectTimeout=10 -o ConnectionAttempts=3"

          # Start Tunnel
          echo "Opening tunnel to $POSTGRES_HOST:5432..."
          ssh $SSH_OPTS -J "${JUMP_USER}@${JUMP_HOST}:${JUMP_PORT}" \
                -p $DEPLOY_PORT -fNT -L 5432:$POSTGRES_HOST:5432 \
                $DEPLOY_USER@$DEPLOY_HOST &
          PID=$!

          sleep 5

          # Wait for Tunnel
          for i in {1..12}; do
            if timeout 1 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/5432' 2>/dev/null; then
              echo "Tunnel ready!"
              break
            fi
            echo "Waiting... $i/12"
            sleep 2
          done || { echo "Tunnel failed"; kill $PID 2>/dev/null; exit 1; }

          # Execute Reset
          export DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@127.0.0.1:5432/${POSTGRES_DB}?schema=public"

          echo "Running prisma migrate reset..."
          # --force skips the interactive confirmation prompt required in non-interactive environments
          bunx prisma migrate reset --force

          # Cleanup
          kill $PID 2>/dev/null || true
          echo "Cleanup done"
