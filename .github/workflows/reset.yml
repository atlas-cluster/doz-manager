name: Manual DB Reset

on:
  workflow_dispatch:

jobs:
  reset-db:
    name: Reset Database
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install & Generate Prisma
        run: |
          npm ci
          npx prisma generate

      - name: Prepare SSH (known_hosts + key)
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Generate known_hosts dynamically
          echo "Generating known_hosts..."
          JUMP_HOST="${{ secrets.JUMP_HOST }}"
          JUMP_PORT="${{ secrets.JUMP_PORT || 22 }}"
          DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
          DEPLOY_PORT="${{ secrets.DEPLOY_PORT || 22 }}"

          timeout 10 ssh-keyscan -p "$JUMP_PORT" -H "$JUMP_HOST" >> ~/.ssh/known_hosts || echo "JUMP warn: retry later"
          timeout 10 ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts || echo "DEPLOY warn: retry later"

          chmod 600 ~/.ssh/known_hosts

      - name: SSH Tunnel + Reset
        env:
          JUMP_HOST: ${{ secrets.JUMP_HOST }}
          JUMP_USER: ${{ secrets.JUMP_USER }}
          JUMP_PORT: ${{ secrets.JUMP_PORT || 22 }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT || 22 }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: 3306
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_ROOT_USER: ${{ secrets.DB_ROOT_USER }}
          DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
        run: |
          SSH_OPTS="-i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=accept-new -o ConnectTimeout=10 -o ConnectionAttempts=3"

          # Start Tunnel
          echo "Tunnel -> $DB_HOST:$DB_PORT"
          ssh $SSH_OPTS -J "${JUMP_USER}@${JUMP_HOST}:${JUMP_PORT}" \
                -p $DEPLOY_PORT -fNT -L 3306:$DB_HOST:$DB_PORT \
                $DEPLOY_USER@$DEPLOY_HOST &
          PID=$!

          sleep 5

          # Wait for Tunnel
          for i in {1..12}; do
            if timeout 1 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/3306' 2>/dev/null; then
              echo "Tunnel ready!"
              break
            fi
            echo "Waiting... $i/12"
            sleep 2
          done || { echo "Tunnel failed"; kill $PID 2>/dev/null; exit 1; }

          export DB_ROOT_URL="mysql://${DB_ROOT_USER}:${DB_ROOT_PASSWORD}@127.0.0.1:3306/${DB_NAME}"

          echo "Running prisma migrate reset..."
          npx prisma migrate reset --force --skip-seed

          # Cleanup
          kill $PID 2>/dev/null || true
          ssh $SSH_OPTS -O exit $DEPLOY_USER@$DEPLOY_HOST 2>/dev/null || true
          echo "Cleanup done"
